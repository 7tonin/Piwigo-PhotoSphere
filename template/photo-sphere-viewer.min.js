/*!
 * Photo Sphere Viewer 3.0.0
 * Copyright (c) 2014-2015 Jérémy Heleine
 * Copyright (c) 2015 Damien "Mistic" Sorel
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */

!function(a,b){"function"==typeof define&&define.amd?define(["three"],b):a.PhotoSphereViewer=b(a.THREE)}(this,function(a){"use strict";var b=function(a){if(void 0===a||void 0===a.panorama||void 0===a.container)throw"PhotoSphereViewer: no value given for panorama or container";this.config=h.deepmerge(b.DEFAULTS,a),this.config.min_fov=h.stayBetween(this.config.min_fov,1,179),this.config.max_fov=h.stayBetween(this.config.max_fov,1,179),this.config.default_fov=null===this.config.default_fov?this.config.max_fov:h.stayBetween(this.config.default_fov,this.config.min_fov,this.config.max_fov),this.container=this.config.container,this.loader=null,this.navbar=null,this.canvas_container=null,this.renderer=null,this.scene=null,this.camera=null,this.actions={},this.prop={fps:60,phi:0,theta:0,theta_offset:0,zoom_lvl:0,mousedown:!1,mouse_x:0,mouse_y:0,autorotate_timeout:null,anim_timeout:null,size:{width:0,height:0,ratio:0}},this.prop.zoom_lvl=Math.round((this.config.default_fov-this.config.min_fov)/(this.config.max_fov-this.config.min_fov)*100),this.prop.zoom_lvl-=2*(this.prop.zoom_lvl-50),this.setAnimSpeed(this.config.anim_speed),this.rotate(this.config.default_long,this.config.default_lat),null!==this.config.size&&this._setViewerSize(this.config.size),this.config.autoload&&this.load()};b.DEFAULTS={panorama:null,container:null,caption:null,autoload:!0,usexmpdata:!0,min_fov:30,max_fov:90,default_fov:null,default_long:0,default_lat:0,long_offset:Math.PI/720,lat_offset:Math.PI/360,time_anim:2e3,anim_speed:"2rpm",navbar:!1,mousewheel:!0,loading_img:null,size:null},b.prototype.load=function(){return h.addClass(this.container,"psv-container loading"),h.isCanvasSupported()?(this.config.loading_img?(this.loader=document.createElement("img"),this.loader.src=this.config.loading_img,this.loader.alt="Loading..."):(this.loader=document.createElement("div"),this.loader.textContent="Loading..."),this.loader.className="psv-loader",this.container.appendChild(this.loader),this.canvas_container=document.createElement("div"),this.canvas_container.className="psv-canvas",this.container.appendChild(this.canvas_container),this.config.navbar&&(this.navbar=new c(this),this.container.appendChild(this.navbar.getBar())),h.addEvent(window,"resize",this._onResize.bind(this)),h.addEvent(this.canvas_container,"mousedown",this._onMouseDown.bind(this)),h.addEvent(this.canvas_container,"touchstart",this._onTouchStart.bind(this)),h.addEvent(document,"mouseup",this._onMouseUp.bind(this)),h.addEvent(document,"touchend",this._onMouseUp.bind(this)),h.addEvent(document,"mousemove",this._onMouseMove.bind(this)),h.addEvent(document,"touchmove",this._onTouchMove.bind(this)),this.config.mousewheel&&(h.addEvent(this.canvas_container,"mousewheel",this._onMouseWheel.bind(this)),h.addEvent(this.canvas_container,"DOMMouseScroll",this._onMouseWheel.bind(this))),h.addEvent(document,"fullscreenchange",this._fullscreenToggled.bind(this)),h.addEvent(document,"mozfullscreenchange",this._fullscreenToggled.bind(this)),h.addEvent(document,"webkitfullscreenchange",this._fullscreenToggled.bind(this)),h.addEvent(document,"MSFullscreenChange",this._fullscreenToggled.bind(this)),void(this.config.usexmpdata?this._loadXMP():this._createBuffer(!1))):void(this.container.textContent="Canvas is not supported, update your browser!")},b.prototype._loadXMP=function(){var a=null,b=this;if(window.XMLHttpRequest)a=new XMLHttpRequest;else{if(!window.ActiveXObject)return void(this.container.textContent="XHR is not supported, update your browser!");try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){a=new ActiveXObject("Microsoft.XMLHTTP")}}a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var c=a.responseText,d=c.indexOf("<x:xmpmeta"),e=c.indexOf("</x:xmpmeta>"),f=c.substring(d,e);if(-1==d||-1==e||-1==f.indexOf("GPano:"))return void b._createBuffer(!1);var g={full_width:parseInt(h.getAttribute(f,"FullPanoWidthPixels")),full_height:parseInt(h.getAttribute(f,"FullPanoHeightPixels")),cropped_width:parseInt(h.getAttribute(f,"CroppedAreaImageWidthPixels")),cropped_height:parseInt(h.getAttribute(f,"CroppedAreaImageHeightPixels")),cropped_x:parseInt(h.getAttribute(f,"CroppedAreaLeftPixels")),cropped_y:parseInt(h.getAttribute(f,"CroppedAreaTopPixels"))};b._createBuffer(g)}},a.open("GET",this.config.panorama,!0),a.send(null)},b.prototype._createBuffer=function(a){var b=new Image,c=this;b.onload=function(){a||(a={full_width:b.width,full_height:b.height,cropped_width:b.width,cropped_height:b.height,cropped_x:0,cropped_y:0});var d=2048;h.isWebGLSupported()&&(d=h.getMaxTextureWidth());var e=Math.min(a.full_width,d),f=e/a.full_width;a.full_width=e,a.cropped_width*=f,a.cropped_x*=f,b.width=a.cropped_width,a.full_height*=f,a.cropped_height*=f,a.cropped_y*=f,b.height=a.cropped_height;var g=document.createElement("canvas");g.width=a.full_width,g.height=a.full_height;var i=g.getContext("2d");i.drawImage(b,a.cropped_x,a.cropped_y,a.cropped_width,a.cropped_height),c._loadTexture(g.toDataURL("image/jpeg"))},this.config.panorama.match(/^data:image\/[a-z]+;base64/)||b.setAttribute("crossOrigin","anonymous"),b.src=this.config.panorama},b.prototype._loadTexture=function(b){var c=new a.Texture,d=new a.ImageLoader,e=this;d.load(b,function(a){c.needsUpdate=!0,c.image=a,e._createScene(c)})},b.prototype._createScene=function(b){this._onResize(),this.renderer=h.isWebGLSupported()?new a.WebGLRenderer:new a.CanvasRenderer,this.renderer.setSize(this.prop.size.width,this.prop.size.height),this.camera=new a.PerspectiveCamera(this.config.default_fov,this.prop.size.ratio,1,300),this.camera.position.set(0,0,0),this.scene=new a.Scene,this.scene.add(this.camera);var c=new a.SphereGeometry(200,32,32),d=new a.MeshBasicMaterial({map:b,overdraw:!0}),e=new a.Mesh(c,d);e.scale.x=-1,this.scene.add(e),this.canvas_container.appendChild(this.renderer.domElement),this.container.removeChild(this.loader),h.removeClass(this.container,"loading"),this.config.time_anim!==!1&&(this.prop.anim_timeout=setTimeout(this.startAutorotate.bind(this),this.config.time_anim)),this.trigger("ready"),this.render()},b.prototype.render=function(){var b=new a.Vector3;b.setX(Math.cos(this.prop.phi)*Math.sin(this.prop.theta)),b.setY(Math.sin(this.prop.phi)),b.setZ(Math.cos(this.prop.phi)*Math.cos(this.prop.theta)),this.camera.lookAt(b),this.renderer.render(this.scene,this.camera)},b.prototype._autorotate=function(){this.rotate(this.prop.theta-this.prop.theta_offset-2*Math.floor(this.prop.theta/(2*Math.PI))*Math.PI,this.prop.phi-this.prop.phi/200),this.prop.autorotate_timeout=setTimeout(this._autorotate.bind(this),1e3/this.prop.fps)},b.prototype.startAutorotate=function(){this._autorotate(),this.trigger("autorotate",!0)},b.prototype.stopAutorotate=function(){clearTimeout(this.prop.anim_timeout),this.prop.anim_timeout=null,clearTimeout(this.prop.autorotate_timeout),this.prop.autorotate_timeout=null,this.trigger("autorotate",!1)},b.prototype.toggleAutorotate=function(){clearTimeout(this.prop.anim_timeout),this.prop.autorotate_timeout?this.stopAutorotate():this.startAutorotate()},b.prototype._onResize=function(){(this.container.clientWidth!=this.prop.size.width||this.container.clientHeight!=this.prop.size.height)&&this.resize(this.container.clientWidth,this.container.clientHeight)},b.prototype.resize=function(a,b){this.prop.size.width=parseInt(a),this.prop.size.height=parseInt(b),this.prop.size.ratio=this.prop.size.width/this.prop.size.height,this.camera&&(this.camera.aspect=this.prop.size.ratio,this.camera.updateProjectionMatrix()),this.renderer&&(this.renderer.setSize(this.prop.size.width,this.prop.size.height),this.render()),this.trigger("size-updated",this.prop.size.width,this.prop.size.height)},b.prototype._onMouseDown=function(a){this._startMove(parseInt(a.clientX),parseInt(a.clientY))},b.prototype._onTouchStart=function(a){var b=a.changedTouches[0];b.target.parentNode==this.canvas_container&&this._startMove(parseInt(b.clientX),parseInt(b.clientY))},b.prototype._startMove=function(a,b){this.prop.mouse_x=a,this.prop.mouse_y=b,this.stopAutorotate(),this.prop.mousedown=!0},b.prototype._onMouseUp=function(a){this.prop.mousedown=!1},b.prototype._onMouseMove=function(a){a.preventDefault(),this._move(parseInt(a.clientX),parseInt(a.clientY))},b.prototype._onTouchMove=function(a){var b=a.changedTouches[0];b.target.parentNode==this.canvas_container&&(a.preventDefault(),this._move(parseInt(b.clientX),parseInt(b.clientY)))},b.prototype._move=function(a,b){this.prop.mousedown&&(this.rotate(this.prop.theta+(a-this.prop.mouse_x)*this.config.long_offset,this.prop.phi+(b-this.prop.mouse_y)*this.config.lat_offset),this.prop.mouse_x=a,this.prop.mouse_y=b)},b.prototype.rotate=function(a,b){this.prop.theta=a,this.prop.phi=h.stayBetween(b,-Math.PI/2,Math.PI/2),this.renderer&&this.render(),this.trigger("position-updated",this.prop.theta,this.prop.phi)},b.prototype._onMouseWheel=function(a){a.preventDefault(),a.stopPropagation();var b=a.detail?-a.detail:a.wheelDelta;if(0!==b){var c=parseInt(b/Math.abs(b));this.zoom(this.prop.zoom_lvl+c)}},b.prototype.zoom=function(a){this.prop.zoom_lvl=h.stayBetween(parseInt(Math.round(a)),0,100),this.camera.fov=this.config.max_fov+this.prop.zoom_lvl/100*(this.config.min_fov-this.config.max_fov),this.camera.updateProjectionMatrix(),this.render(),this.trigger("zoom-updated",this.prop.zoom_lvl)},b.prototype.zoomIn=function(){this.prop.zoom_lvl<100&&this.zoom(this.prop.zoom_lvl+1)},b.prototype.zoomOut=function(){this.prop.zoom_lvl>0&&this.zoom(this.prop.zoom_lvl-1)},b.prototype._fullscreenToggled=function(){this.trigger("fullscreen-updated",h.isFullscreenEnabled())},b.prototype.toggleFullscreen=function(){h.isFullscreenEnabled()?h.exitFullscreen():h.requestFullscreen(this.container)},b.prototype.setAnimSpeed=function(a){a=a.toString().trim();var b=parseFloat(a.replace(/^(-?[0-9]+(?:\.[0-9]*)?).*$/,"$1")),c=a.replace(/^-?[0-9]+(?:\.[0-9]*)?(.*)$/,"$1").trim();c.match(/(pm|per minute)$/)&&(b/=60);var d=0;switch(c){case"rpm":case"rev per minute":case"revolutions per minute":case"rps":case"rev per second":case"revolutions per second":d=2*b*Math.PI;break;case"dpm":case"deg per minute":case"degrees per minute":case"dps":case"deg per second":case"degrees per second":d=b*Math.PI/180;break;case"rad per minute":case"radians per minute":case"rad per second":case"radians per second":d=b;break;default:m_anim=!1}this.prop.theta_offset=d/this.prop.fps},b.prototype._setViewerSize=function(a){for(var b in a)("width"==b||"height"==b)&&(/^[0-9.]+$/.test(a[b])&&(a[b]+="px"),this.container.style[b]=a[b])},b.prototype.on=function(a,b){a in this.actions||(this.actions[a]=[]),this.actions[a].push(b)},b.prototype.trigger=function(a,b){if(a in this.actions&&this.actions[a].length>0)for(var c=0,d=this.actions[a].length;d>c;++c)this.actions[a][c](b)};var c=function(a){this.psv=a,this.container=null,this.autorotateBtn=null,this.zoomBar=null,this.fullscreenBtn=null,this.caption=null,this.create()};c.prototype.create=function(){this.container=document.createElement("div"),this.container.className="psv-navbar",this.autorotateBtn=new e(this.psv),this.container.appendChild(this.autorotateBtn.getButton()),this.zoomBar=new g(this.psv),this.container.appendChild(this.zoomBar.getButton()),this.fullscreenBtn=new f(this.psv),this.container.appendChild(this.fullscreenBtn.getButton()),this.caption=document.createElement("div"),this.caption.className="psv-caption",this.container.appendChild(this.caption),this.setCaption(this.psv.config.caption)},c.prototype.getBar=function(){return this.container},c.prototype.setCaption=function(a){a?(this.caption.style.display="block",this.caption.innerHTML=a):this.caption.style.display="none"};var d=function(a){this.psv=a,this.button=null};d.prototype.create=function(){throw"Not implemented"},d.prototype.getButton=function(){return this.button},d.prototype.toggleActive=function(a){a?h.addClass(this.button,"active"):h.removeClass(this.button,"active")};var e=function(a){d.call(this,a),this.create()};e.prototype=Object.create(d.prototype),e.prototype.constructor=e,e.prototype.create=function(){this.button=document.createElement("div"),this.button.className="psv-button psv-autorotate-button";var a=document.createElement("div");a.className="psv-autorotate-sphere",this.button.appendChild(a);var b=document.createElement("div");b.className="psv-autorotate-equator",this.button.appendChild(b),h.addEvent(this.button,"click",this.psv.toggleAutorotate.bind(this.psv)),this.psv.on("autorotate",this.toggleActive.bind(this))};var f=function(a){d.call(this,a),this.create()};f.prototype=Object.create(d.prototype),f.prototype.constructor=f,f.prototype.create=function(){this.button=document.createElement("div"),this.button.className="psv-button psv-fullscreen-button",this.button.appendChild(document.createElement("div")),this.button.appendChild(document.createElement("div")),h.addEvent(this.button,"click",this.psv.toggleFullscreen.bind(this.psv)),this.psv.on("fullscreen-updated",this.toggleActive.bind(this))};var g=function(a){d.call(this,a),this.zoom_range=null,this.zoom_value=null,this.mousedown=!1,this.create()};g.prototype=Object.create(d.prototype),g.prototype.constructor=g,g.prototype.create=function(){this.button=document.createElement("div"),this.button.className="psv-button psv-zoom-button";var a=document.createElement("div");a.className="psv-zoom-minus",this.button.appendChild(a);var b=document.createElement("div");b.className="psv-zoom-range",this.button.appendChild(b),this.zoom_range=document.createElement("div"),this.zoom_range.className="psv-zoom-range-line",b.appendChild(this.zoom_range),this.zoom_value=document.createElement("div"),this.zoom_value.className="psv-zoom-range-handle",this.zoom_range.appendChild(this.zoom_value);var c=document.createElement("div");c.className="psv-zoom-plus",this.button.appendChild(c),h.addEvent(this.zoom_range,"mousedown",this._initZoomChangeWithMouse.bind(this)),h.addEvent(this.zoom_range,"touchstart",this._initZoomChangeByTouch.bind(this)),h.addEvent(document,"mousemove",this._changeZoomWithMouse.bind(this)),h.addEvent(document,"touchmove",this._changeZoomByTouch.bind(this)),h.addEvent(document,"mouseup",this._stopZoomChange.bind(this)),h.addEvent(document,"touchend",this._stopZoomChange.bind(this)),h.addEvent(a,"click",this.psv.zoomOut.bind(this.psv)),h.addEvent(c,"click",this.psv.zoomIn.bind(this.psv)),this.psv.on("zoom-updated",this._moveZoomValue.bind(this));var d=this;setTimeout(function(){d._moveZoomValue(d.psv.prop.zoom_lvl)},0)},g.prototype._moveZoomValue=function(a){this.zoom_value.style.left=a/100*this.zoom_range.offsetWidth-this.zoom_value.offsetWidth/2+"px"},g.prototype._initZoomChangeWithMouse=function(a){this._initZoomChange(parseInt(a.clientX))},g.prototype._initZoomChangeByTouch=function(a){var b=a.changedTouches[0];(b.target==this.zoom_range||b.target==this.zoom_value)&&this._initZoomChange(parseInt(b.clientX))},g.prototype._initZoomChange=function(a){this.mousedown=!0,this._changeZoom(a)},g.prototype._stopZoomChange=function(a){this.mousedown=!1},g.prototype._changeZoomWithMouse=function(a){a.preventDefault(),this._changeZoom(parseInt(a.clientX))},g.prototype._changeZoomByTouch=function(a){var b=a.changedTouches[0];(b.target==this.zoom_range||b.target==this.zoom_value)&&(a.preventDefault(),this._changeZoom(parseInt(b.clientX)))},g.prototype._changeZoom=function(a){if(this.mousedown){var b=a-this.zoom_range.getBoundingClientRect().left,c=b/this.zoom_range.offsetWidth*100;this.psv.zoom(c)}};var h={};return h.addClass=function(a,b){a.className.length?a.className+=" "+b:a.className=b},h.removeClass=function(a,b){a.className.length&&(a.className=a.className.replace(new RegExp("\\b"+b+"\\b"),"").trim())},h.isCanvasSupported=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))},h.isWebGLSupported=function(){var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl"))},h.getMaxTextureWidth=function(){var a=document.createElement("canvas"),b=a.getContext("webgl");return b.getParameter(b.MAX_TEXTURE_SIZE)},h.addEvent=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},h.stayBetween=function(a,b,c){return Math.max(b,Math.min(c,a))},h.getAttribute=function(a,b){var c=a.indexOf("GPano:"+b)+b.length+8,d=a.indexOf('"',c);return a.substring(c,d)},h.isFullscreenEnabled=function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement},h.requestFullscreen=function(a){(a.requestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullscreen||a.msRequestFullscreen).call(a)},h.exitFullscreen=function(a){(document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document)},h.deepmerge=function(a,b){var c=Array.isArray(b),d=c&&[]||{};return c?(a=a||[],d=d.concat(a),b.forEach(function(b,c){"undefined"==typeof d[c]?d[c]=b:"object"==typeof b?d[c]=h.deepmerge(a[c],b):-1===a.indexOf(b)&&d.push(b)})):(a&&"object"==typeof a&&Object.keys(a).forEach(function(b){d[b]=a[b]}),Object.keys(b).forEach(function(c){d[c]="object"==typeof b[c]&&b[c]&&a[c]?h.deepmerge(a[c],b[c]):b[c]})),d},b});